@using LoadVantage.Core.Models.Profile
@using LoadVantage.Extensions
@using Microsoft.AspNetCore.Mvc.TagHelpers
@model LoadVantage.Core.Models.Chat.ChatViewModel

@{
	ViewData["Title"] = "Chats";
	Layout = "~/Views/Shared/_LoggedInLayout.cshtml";

	var tempDataSuccessMessage = TempData.GetSuccessMessage();
	var tempDataErrorMessage = TempData.GetErrorMessage();

}


<!-- ======= Header ======= -->
@await Html.PartialAsync("_HeaderPartialView", new ProfileViewModel())

<!-- End Header -->
<!-- ======= Sidebar ======= -->
@await Html.PartialAsync("_SidebarPartialView", new ProfileViewModel())



<main id="main" class="main">

    <div class="pagetitle">
        <h1>Chats</h1>
        
    </div>


    <div class="card">
	    <div class="card-body justify-content-center">

		    @if (!string.IsNullOrEmpty(tempDataSuccessMessage))
		    {
			    <div class="badge badge-danger mt-1 d-flex justify-content-center" id="success-message">@tempDataSuccessMessage</div>
		    }

		    @if (!string.IsNullOrEmpty(tempDataErrorMessage))
		    {
			    <div class="badge badge-danger mt-1 d-flex justify-content-center" id="error-message">@tempDataErrorMessage</div>
		    }
			
		    <div class="spinner-container">
			    <div id="loader" class="spinner" style="display: none;">
		                    
				    <div></div>
				    <div></div>
				    <div></div>
				    <div></div>
				    <div></div>
				    <div></div>

			    </div>
		    </div>
	<!-- Chat Layout -->
	<div class="container mt-3">
	    <div class="row">
	        <!-- Sidebar: List of Chat Users (Left Side) -->
	        <div class="col-md-4 col-lg-3">
	            <h5>Chat Users</h5>
	            <ul class="list-group">
	                @foreach (var user in Model.Users)
	                {
	                    <li class="list-group-item @(user.Id == Model.CurrentChatUserId ? "active" : "")">
	                        <a asp-action="GetMessages" asp-controller="Chat" asp-route-chatUserId="@user.Id" 
	                           class="chat-user-link d-flex align-items-center">
	                            <img src="@user.ProfilePictureUrl" class="chat-user-image rounded-circle" style="width: 50px; height: 50px;" />
	                            <span class="ms-3">@user.Name</span>
	                        </a>
	                    </li>
	                }
	            </ul>
	        </div>

	        <!-- Chat Messages (Right Side) -->
	        <div class="col-md-8 col-lg-9">
	            <div class="broker-info card mb-3">
	                <div class="card-body">
	                    <div class="d-flex align-items-center">
	                        <img src="@Model.BrokerInfo.ProfilePictureUrl" alt="@Model.BrokerInfo.FullName" class="profile-img rounded-circle" style="width: 50px; height: 50px;" />
	                        <div class="ms-3">
	                            <h5 class="card-title">@Model.BrokerInfo.FullName</h5>
	                            <p class="card-text">Phone: @Model.BrokerInfo.PhoneNumber</p>
	                            <p class="card-text">Company: @Model.BrokerInfo.Company</p>
	                        </div>
	                    </div>
	                </div>
	            </div>

	            <!-- Chat Messages Container -->
	            <div id="chat-messages-container" style="max-height: 500px; overflow-y: auto;">
	                @await Html.PartialAsync("_ChatMessagesPartialView", Model.Messages)
	            </div>

	            <!-- Message Sending Form -->
	            <form asp-action="SendMessage" asp-controller="Chat" method="post" class="mt-3">
	                @Html.AntiForgeryToken()
	                <input type="hidden" name="receiverId" value="@Model.BrokerInfo.Id" />
	                <div class="input-group">
	                    <input type="text" name="messageContent" class="form-control" placeholder="Type your message..." required />
	                    <button type="submit" class="btn btn-primary">Send</button>
	                </div>
	            </form>
	        </div>
	    </div>
	</div>


			




	    </div>
    </div>

</main><!-- End #main -->

<script>

	if (document.querySelector('.toggle-sidebar-btn')) {

		document.querySelector('.toggle-sidebar-btn').addEventListener('click', function (e) {

			document.body.classList.toggle('toggle-sidebar');
		});
	}

	$(document).on("click", ".chat-user-link", function (e) {
    e.preventDefault();

    const url = $(this).attr("href");

    $.ajax({
        url: url,
        type: "GET",
        success: function(response) {

            $("#chat-messages-container").html(response);
        },
        error: function(xhr, status, error) {
            console.error("Error loading chat history:", error);
        }
    });
});

</script>