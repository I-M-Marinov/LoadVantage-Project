@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using LoadVantage.Extensions
@using LoadVantage.Areas.Admin.Models.Chat;

@model AdminChatViewModel

@{
	ViewData["Title"] = "Chats";
	Layout = "~/Views/Shared/_LoggedInLayout.cshtml";

	var tempDataSuccessMessage = TempData.GetSuccessMessage();
	var tempDataErrorMessage = TempData.GetErrorMessage();
}


<!-- ======= Header ======= -->
@await Html.PartialAsync("~/Areas/Admin/Views/AdminShared/_AdminHeaderPartialView.cshtml", Model.Profile)

<!-- End Header -->
<!-- ======= Sidebar ======= -->
@await Html.PartialAsync("~/Areas/Admin/Views/AdminShared/_AdminSidebarPartialView.cshtml", Model.Profile)

<!-- End Sidebar -->


<main id="main" class="main">

    <div class="pagetitle">
        <h1>Chats</h1>
        
    </div>


    <div class="card chat-card">
	    <div class="card-body justify-content-center">

		    @if (!string.IsNullOrEmpty(tempDataSuccessMessage))
		    {
			    <div class="badge badge-danger mt-1 d-flex justify-content-center" id="success-message">@tempDataSuccessMessage</div>
		    }

		    @if (!string.IsNullOrEmpty(tempDataErrorMessage))
		    {
			    <div class="badge badge-danger mt-1 d-flex justify-content-center" id="error-message">@tempDataErrorMessage</div>
		    }
			
		    <div class="spinner-container">
			    <div id="loader" class="spinner" style="display: none;">
		                    
				    <div></div>
				    <div></div>
				    <div></div>
				    <div></div>
				    <div></div>
				    <div></div>

			    </div>
		    </div>
		    <!-- Chat Layout -->
			@if (ViewData["Message"] == null)
		    {
				<div class="container mt-3">
					<div class="row">
						<!-- Sidebar: List of Chat Users (Left Side) -->
						<div class="col-md-4 col-lg-3">
							<h5>Recent Conversations:</h5>
							<ul class="list-group">
								@foreach (var chatUser in Model.Users)
								{
									<li class="list-group-item @(chatUser.Id == Model.CurrentChatUserId ? "active" : "")" id="chat-user">
										<a asp-area="Admin" asp-action="GetMessages" asp-controller="AdminChat" asp-route-chatUserId="@chatUser.Id"
										   class="chat-user-link d-flex align-items-center">
											<img src="@chatUser.ProfilePictureUrl" class="chat-user-image rounded-circle" style="width: 4em; height: 4em;" />
											<span class="ms-3">@chatUser.FullName</span>
										</a>
									</li>
								}
							</ul>
						</div>

						<!-- Chat Messages (Right Side) -->
						<div class="col-md-8 col-lg-9">

							<div class="broker-info card mb-3">
								@await Html.PartialAsync("~/Areas/Admin/Views/Admin/Chat/_ChatUserInfoPartial.cshtml", Model.UserInfo)
							</div>

							<!-- Chat Messages Container -->
							<div id="chat-messages-container" style="max-height: 500px; overflow-y: auto;">
								@await Html.PartialAsync("~/Areas/Admin/Views/Admin/Chat/_ChatMessagesPartialView.cshtml", Model.Messages)
							</div>


							<!-- Message Sending Form -->

							<form asp-area="Admin" asp-action="SendMessage" asp-controller="AdminChat" method="post" class="mt-3">
								@Html.AntiForgeryToken()
								<input type="hidden" name="receiverId" value="@Model.UserInfo.Id" />
								<input type="hidden" id="senderId" value="@Model.Profile.Id" />
								<div class="input-group">
									<input type="text" name="messageContent" class="form-control" placeholder="Type your message..." required />
									<button type="submit" class="btn btn-success">Send</button>
								</div>
							</form>

						</div>
					</div>
				</div>
		    }

		   
	    </div>
    </div>

</main><!-- End #main -->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.5/signalr.min.js"></script>


<script>


	if (document.querySelector('.toggle-sidebar-btn')) {

		document.querySelector('.toggle-sidebar-btn').addEventListener('click', function (e) {

			document.body.classList.toggle('toggle-sidebar');
		});
	}

	const hasChats = document.getElementById("chat-messages-container") !== null;

	if (hasChats) {

		function scrollToBottom() {
			const chatContainer = $("#chat-messages-container")[0];
			chatContainer.scrollTop = chatContainer.scrollHeight;
		}

		$(document).ready(function () {
			scrollToBottom();
		});

		// Clicking on Chat User Link //

		$(document).on("click", ".chat-user-link", function (e) {
			e.preventDefault();

			const url = $(this).attr("href");
			const urlParams = new URLSearchParams(url.split('?')[1]);
			const userId = urlParams.get("chatUserId");
			if (!userId) {
				alert("Invalid chat user ID.");
				return;
			}

			loadUserInfo(userId);
			loadChatMessages(url);

			$("input[name='receiverId']").val(userId);

		});

		// Clicking on Chat User Link //

		// Loading User Info //
		function loadUserInfo(userId) {
			$.get(`/Chat/GetUserInfo?userId=${userId}`, function (data) {
				$(".broker-info").html(data);
			}).fail(function () {
				alert("Error loading user information.");
			});
		}

		// Loading User Info //

		// Loading Chat Messages //

		function loadChatMessages(url) {
			$("#chat-messages-container").load(url, function (response, status, xhr) {
				if (status === "error") {
					alert("Error loading chat messages.");
				} else {
					scrollToBottom();
				}
			});
		}

		// Loading Chat Messages //
	}

</script>
